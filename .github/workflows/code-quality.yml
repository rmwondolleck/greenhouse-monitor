name: Code Quality

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  typescript-quality:
    name: TypeScript Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for TypeScript errors
        run: |
          echo "## TypeScript Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run standard type check (as configured in project)
          if npx tsc --noEmit 2>&1 | tee ts-errors.log | grep -q "error TS"; then
            echo "âš ï¸ TypeScript errors found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat ts-errors.log
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No TypeScript errors found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check strict mode compliance (informational)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Strict Mode Analysis" >> $GITHUB_STEP_SUMMARY
          if npx tsc --noEmit --strict 2>&1 | grep -q "error TS"; then
            echo "âš ï¸ Not all code is strict-mode compliant (this is informational)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Code is strict-mode compliant" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  code-metrics:
    name: Code Metrics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Count lines of code
        run: |
          echo "## Code Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Lines of Code" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Language | Files | Lines |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|-------|" >> $GITHUB_STEP_SUMMARY
          
          TS_FILES=$(find src -name "*.ts" -o -name "*.tsx" | wc -l)
          TS_LINES=$(find src -name "*.ts" -o -name "*.tsx" -exec cat {} \; | wc -l)
          echo "| TypeScript | $TS_FILES | $TS_LINES |" >> $GITHUB_STEP_SUMMARY
          
          JS_FILES=$(find . -name "*.js" -not -path "./node_modules/*" -not -path "./dist/*" | wc -l)
          JS_LINES=$(find . -name "*.js" -not -path "./node_modules/*" -not -path "./dist/*" -exec cat {} \; | wc -l)
          echo "| JavaScript | $JS_FILES | $JS_LINES |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Project Structure" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tree -L 2 -I 'node_modules|dist|.git' src/ || find src/ -type d | head -20
          echo '```' >> $GITHUB_STEP_SUMMARY

  build-size-check:
    name: Build Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Analyze build size
        run: |
          echo "## Build Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          du -sh dist/
          ls -lh dist/*.js dist/*.html 2>/dev/null || ls -lh dist/ | head -20
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_SIZE=$(du -sh dist/ | cut -f1)
          echo "**Total build size**: $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "## Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if npm audit --audit-level=moderate 2>&1 | tee audit.log; then
            echo "âœ… No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Security vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat audit.log
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Check for secrets in code
        run: |
          echo "### Secret Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for common secret patterns
          if grep -r -n -E "(password|secret|api[_-]?key|token).*=.*['\"][^'\"]{8,}" src/ 2>/dev/null | grep -v ".example"; then
            echo "âš ï¸ Potential secrets found in code" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No obvious secrets detected in code" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [typescript-quality, code-metrics, build-size-check, security-scan]
    if: always()
    steps:
      - name: Generate overall summary
        run: |
          echo "## ðŸ“Š Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript Quality: ${{ needs.typescript-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Metrics: ${{ needs.code-metrics.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Size: ${{ needs.build-size-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.typescript-quality.result }}" == "success" ] && \
             [ "${{ needs.code-metrics.result }}" == "success" ] && \
             [ "${{ needs.build-size-check.result }}" == "success" ] && \
             [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "âœ… All quality checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some quality checks need attention." >> $GITHUB_STEP_SUMMARY
          fi
